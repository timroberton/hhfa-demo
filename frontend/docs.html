<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>HHFA Analysis Platform Documentation</title><link rel="stylesheet" type="text/css" href="/sourcesanspro.css"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/9d6790d5d371e45add00.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9d6790d5d371e45add00.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-fcde7eb9723ef9eaca99.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.7ec230ec27bd2df0a8e4.js" as="script"/><link rel="preload" href="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.38c824b6f6bb792b82e0.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.4521014ec666dee5f411.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-a613de50db3f35b2b8ef.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/docs-423dc63f1cedf372ecac.js" as="script"/></head><body><div id="__next"><div class="w-full h-full font-sourcesanspro overflow-y-auto print:overflow-y-visible print:h-auto"><header class="header bg-gradient-to-br from-blue-800 to-blue-900 text-white"><nav class="w-full tex max-w-5xl mx-auto px-10 nav pt-16 pb-12" role="navigation" aria-label="main navigation"><h1 class="font-extralight text-4xl antialiased">Harmonized Health Facility Assessment</h1><h4 class="mt-3 font-semibold text-4xl antialiased text-white">Analysis Platform</h4><h4 class="mt-7 antialiased font-book text-blue-200">Technical documentation ~ v0.1 ~ 31.12.2020</h4></nav></header><main class="w-full max-w-5xl mx-auto px-10 markdown"><h2>Summary</h2><div><div class="hiddeninprint">
<iframe src="https://player.vimeo.com/video/488278231" width="100%" height="590px" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
</div></div><h3>Veraion 0.1 ~ 31.12.2020</h3><p>This is the first version of the HHFA Analysis Platform (the &quot;platform&quot;). Although it is now functional and can be used to analyze a dataset, producing the necessary tables and graphics for a HHFA report, it is still only the first version of the platform, and we hope to continue improving it into the future.</p><p>The platform is designed to be used by country partners, in the latter stages of a HHFA cycle, for analyzing the dataset that is generated by the HHFA survey toolkit.</p><h3>Objective</h3><p>The purpose of the platform is to allow HHFA stakeholders to <em>quickly and easily</em> generate analysis outputs and a draft report, without the need for specialized statistical software or expertise, while also allowing for flexibility and customizability for those that want to extend the built-in analysis.</p><p>In the ideal case, a user should simply need to:</p><ol><li>Upload their dataset,</li><li>Click &quot;Run&quot;, to analyze their dataset with the default configuration, and</li><li>View and download a full report.</li></ol><p>In reality, there will likely be some customization needed in most cases. But assuming the HHFA survey tool has been used as expected, the need for customization should be minimal.</p><h3>Using the tool</h3><p><img src="/images/a1.png" alt="a1"/></p><p><img src="/images/a2.png" alt="a2"/></p><p><img src="/images/a3.png" alt="a3"/></p><p><img src="/images/a4.png" alt="a4"/></p><p><img src="/images/a5.png" alt="a5"/></p><p><img src="/images/a6.png" alt="a6"/></p><p><img src="/images/b1.png" alt="b1"/></p><p><img src="/images/b2.png" alt="b2"/></p><p><img src="/images/c1.png" alt="c1"/></p><p><img src="/images/c2.png" alt="c2"/></p><p><img src="/images/d1.png" alt="d1"/></p><p><img src="/images/d2.png" alt="d2"/></p><p><img src="/images/d3.png" alt="d3"/></p><p><img src="/images/d4.png" alt="d4"/></p><p>This is a demo of the HHFA Analysis Tool. It is meant to showcase the <strong><em>architecture only</em></strong>. It doesn&#x27;t capture the statistical code that is the heart of the tool.</p><p>The demo allows you to:</p><ol><li>Start a session</li><li>Upload a data file</li><li>Use a basic query builder to generate an R script to be run on the data file</li><li>View outputs from the generated R script</li></ol><h2>Example dataset</h2><p>For playing with the demo, you can use the example dataset (<a href="https://github.com/timroberton/hhfa-demo/blob/master/example_dataset.dta">example_dataset.dta</a>) or any other <code>.dta</code> file.</p><h2>Demo of the demo</h2><p>You can see the demo already deployed at the following addresses:</p><p><strong>Frontend</strong> (hosted on Netlify with custom subdomain): <a href="https://tr-hhfa-1.netlify.app/">https://tr-hhfa-1.netlify.app/</a></p><p><strong>Backend</strong> (hosted on Digital Ocean behind NGINX service with custom domain): <a href="https://hhfa.capacityapps.xyz/">https://hhfa.capacityapps.xyz/</a></p><h2>Walk-through video</h2><p>I made a one-minute screencapture of me using the demo app, which I put <a href="https://github.com/timroberton/hhfa-demo/blob/master/demo_screencast.mov">here</a>. You need to download the file to watch it.</p><h1>Deployment</h1><p>There are two components to the analysis tool: a frontend (HTML/CSS/JS) and a backend (compiled binary, containerized with R). Both components are included in this repo.</p><h3>Frontend</h3><p>The frontend is a single-page web app (client). It should be served via a regular http server. It is built using Typescript/React/Webpack, and compiled to HTML/CSS/JS. In this repo you can see the compiled HTML/CSS/JS (in the <code>/frontend</code> directory), ready to be served as a static page. Drop it in a <code>www</code> folder or use a tool such as <a href="https://www.npmjs.com/package/serve">serve</a> to serve the client.</p><p>When you navigate to the client for the first time, it will ask for the backend URL. (If you are running the backend locally using Option 1 described below, the URL will be <code>http://localhost:9000</code>.) This feature is for the demo only. If we decide on a permanent backend address, we can eliminate this step.</p><h3>Backend</h3><p>The backend server is responsible for:</p><ol><li>Temporarily storing data files uploaded from the client</li><li>Rendering analysis scripts (from parameters/data that are sent to the backend from the client)</li><li>Running the analysis scripts on the data files</li><li>Temporarily serving the statistical outputs of the analysis scripts (e.g. images, csv files)</li></ol><p>The backend is written in Rust and compiled to an executable binary. This repo contains the <em>source code only</em> for the binary (in the <code>/backend</code> directory).</p><p>You will need to compile the binary using one of the following two deployment options. <strong><em>I strongly suggest the first option.</em></strong></p><p><strong>Option 1.</strong> Build and run the backend as a Docker container. This builds the Rust binary inside the Docker image and does not require you to install Rust or R. It only requires you to install Docker.</p><p>Assuming you have Docker already installed, the build process is straightforward.</p><pre><code>cd backend
docker build -t hhfa-demo-backend .
docker run -d --rm -p 9000:9000 hhfa-demo-backend hhfa</code></pre><p>The build step may take several minutes. The first time will take longer, because Docker will need to pull the two base images used in the Dockerfile (<code>rustlang/rust:nightly</code> and <code>rocker/tidyverse:4.0.2</code>).</p><p>The resulting Docker image is large because it contains R and the tidyverse package.</p><p>When running the Docker container, you need to pass the <code>hhfa</code> command as the first and only argument (per the above code) - i.e. the container is not self-executing; you need to give it the <code>hhfa</code> command.</p><p>You can choose which port to run the backend on. The default is <code>:9000</code>, as shown above by the <code>-p 9000:9000</code> flag.</p><p><strong>Option 2.</strong> A second deployment option is to build the binary outside of Docker (using <a href="https://doc.rust-lang.org/cargo/index.html">Cargo</a>, the Rust package manager) and run it as a standalone binary executable.</p><pre><code>cd backend
mkdir sessions
cargo run --release</code></pre><p>However, this still requires you to have Docker installed for the purposes of running R. You will need to ensure that you have the R Docker image available locally (<code>rocker/tidyverse:4.0.2</code>) and that the binary has the necessary permissions to call <code>docker run</code>.</p><p>Also note that if you choose this option, you will need to create a <code>sessions</code> directory next to the binary (per the above code).</p><p>As I said, I think option 1 is the best.</p><h3>Additional notes on backend deployment</h3><p>For <strong>production</strong> deployment of the backend, we will also need to:</p><ul><li>Put behind SSL / HTTPS</li><li>Ensure uploads of up to 1 Gb (some services like NGINX restrict size of uploads by default)</li></ul><h2>Backend endpoints</h2><span><div class="breaker">.</div></span><p>The key processes of the backend can be seen in the <code>main.rs</code> source file. The URL endpoints are as follows:</p><pre><code class="language-shell"># Endpoints for creating and removing session folders
GET /new_session
GET /end_session/&lt;sessionId&gt;

# Endpoints for uploading and parsing data files
POST /upload/&lt;session_id&gt;
POST /varlist
GET /delete_upload/&lt;session_id&gt;/&lt;file_name&gt;

# Endpoints for running analyses and streaming output files
POST /render_script
POST /analyze
GET /stream_file/&lt;session_id&gt;/&lt;temp_id&gt;/&lt;file_name&gt;</code></pre><p>All endpoints return a JSON object with the same structure...</p><pre><code class="language-javascript">{
    error: boolean,
    msg: string,
    data: T,
}</code></pre><p>The only exception is the <code>/stream_file</code> endpoint, which returns the requested file as a stream, and the <code>/upload</code> endpoint, which returns an HTTP status code.</p><h2>Known issues and todos</h2><ul><li>Need to implement session timeout, including alerts to user and regular clean-up on backend.</li><li>Need to consolidate <code>/upload</code> and <code>/varlist</code> endpoints. Currently, after an upload, the <code>/varlist</code> endpoint is triggered via a second http request, which validates the file and extracts variable data. I will consolidate the two, so that the <code>/varlist</code> process is part of the same, single http request to <code>/upload</code>.</li><li>Need to persist data to <code>localStorage</code>, so users can return to their work after closing the browser.</li></ul></main><footer class="w-full"><div class="w-full max-w-5xl mx-auto px-10 pt-6 pb-12 text-blue-700 font-light"><div class="border-b-2 mb-3 border-blue-200"></div><div class=""><div class="antialiased font-book">Tim Roberton</div><div class="antialiased font-book">timroberton@gmail.com</div><div class="antialiased font-book">+1 (443) 844 9749</div></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/docs","query":{},"buildId":"0_jPQYjisTQbkEbIN0KxI","runtimeConfig":{},"nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-d2769c16f665abc9d1ae.js"></script><script src="/_next/static/chunks/main-fcde7eb9723ef9eaca99.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.7ec230ec27bd2df0a8e4.js" async=""></script><script src="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.38c824b6f6bb792b82e0.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.4521014ec666dee5f411.js" async=""></script><script src="/_next/static/chunks/pages/_app-a613de50db3f35b2b8ef.js" async=""></script><script src="/_next/static/chunks/pages/docs-423dc63f1cedf372ecac.js" async=""></script><script src="/_next/static/0_jPQYjisTQbkEbIN0KxI/_buildManifest.js" async=""></script><script src="/_next/static/0_jPQYjisTQbkEbIN0KxI/_ssgManifest.js" async=""></script></body></html>